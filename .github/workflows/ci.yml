name: ci.yml
on:
  pull_request:
    branches:
      - "develop"
      - "main"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check runner info
        run: |
          echo "Runner: $(uname -a)"
          echo "Java home before setup: $JAVA_HOME"

      - name: Check Docker availability (basic)
        run: |
          echo "=== docker version ==="
          docker version || true
          echo "=== docker info ==="
          docker info || true
          echo "=== docker ps ==="
          docker ps -a || true
          echo "=== quick docker run hello-world ==="
          docker run --rm hello-world || true

      - name: JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Grant execute to gradlew
        run: chmod +x ./gradlew

      # Optional: show Gradle and Java versions
      - name: Java & Gradle versions
        run: |
          java -version
          ./gradlew -v

      - name: Run tests with Testcontainers debug logs
        # Testcontainers debug 출력, 그리고 fail 시에도 콘솔에 남기기 위해 소유 환경 변수와 system properties를 설정
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_S3_PRESIGNED_URL_EXPIRATION: ${{ secrets.AWS_S3_PRESIGNED_URL_EXPIRATION }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          JWT_KEY: ${{ secrets.JWT_KEY }}
          ACCESS_TOKEN_EXPIRATION_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRATION_MINUTES }}
          REFRESH_TOKEN_EXPIRATION_MINUTES: ${{ secrets.REFRESH_TOKEN_EXPIRATION_MINUTES }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          TMDB_API_TOKEN: ${{ secrets.TMDB_API_TOKEN }}
          TMDB_BASE_URL: ${{ secrets.TMDB_BASE_URL }}
          OAUTH2_GOOGLE_CLIENT_ID: ${{ secrets.OAUTH2_GOOGLE_CLIENT_ID }}
          OAUTH2_GOOGLE_CLIENT_SECRET: ${{ secrets.OAUTH2_GOOGLE_CLIENT_SECRET }}
          OAUTH2_KAKAO_CLIENT_ID: ${{ secrets.OAUTH2_KAKAO_CLIENT_ID }}
          OAUTH2_KAKAO_CLIENT_SECRET: ${{ secrets.OAUTH2_KAKAO_CLIENT_SECRET }}
          HOST: ${{ secrets.HOST }}
          # Testcontainers specific debug
          ORG_TESTCONTAINERS_DEBUG: "true"
          TESTCONTAINERS_RYUK_DISABLED: "false"
        # Gradle 실행: Testcontainers 로그 레벨 높이기 위한 JVM system properties 전달
        run: |
          ./gradlew clean test \
            -Dspring.profiles.active=test \
            -Dorg.testcontainers=DEBUG \
            -Dorg.slf4j.simpleLogger.log.org.testcontainers=DEBUG \
            -Dorg.slf4j.simpleLogger.defaultLogLevel=info \
            --no-daemon \
            --stacktrace || echo "Gradle exited with non-zero status"

      - name: Dump possible test failure details (tests, surefire/junit reports)
        if: always()
        run: |
          echo "=== ls build/test-results ==="
          ls -la build/test-results || true
          echo "=== ls build/reports/tests ==="
          ls -la build/reports/tests || true
          echo "=== tail test console logs if exist ==="
          find build -type f -name "*.log" -maxdepth 4 -print -exec sed -n '1,200p' {} \; || true

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/reports/jacoco/test/jacocoTestReport.xml
          fail_ci_if_error: true
          verbose: true
